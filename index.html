<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geotagging Usaha - Data Samosir</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f5f5f5;
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #2196F3, #1976D2);
            color: white;
            padding: 20px;
            text-align: center;
        }

        header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        @media (min-width: 992px) {
            .content {
                flex-direction: row;
            }
        }

        .map-section {
            flex: 1;
            min-height: 500px;
            border-right: 1px solid #eee;
        }

        .form-section {
            flex: 1;
            min-width: 400px;
            padding: 20px;
            overflow-y: auto;
            max-height: 700px;
        }

        #map {
            width: 100%;
            height: 500px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2196F3;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .coordinates-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
            border: 1px solid #ddd;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #757575;
            color: white;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #616161;
        }

        .btn-location {
            background: #2196F3;
            color: white;
            margin-top: 10px;
        }

        .btn-location:hover {
            background: #1976D2;
        }

        .map-controls {
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid #eee;
        }

        .status-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .status-option {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            font-weight: 500;
        }

        .status-option:hover {
            border-color: #2196F3;
        }

        .status-option.selected {
            border-color: #4CAF50;
            background: #E8F5E9;
        }

        .status-option[data-status="Ditemukan"] {
            color: #4CAF50;
        }

        .status-option[data-status="Pindah"] {
            color: #FF9800;
        }

        .status-option[data-status="Tutup"] {
            color: #F44336;
        }

        .status-option[data-status="Tidak Ditemukan"] {
            color: #9E9E9E;
        }

        .required {
            color: #F44336;
        }

        .instructions {
            background: #E3F2FD;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.5;
        }

        .instructions ol {
            padding-left: 20px;
            margin-top: 5px;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        .data-counter {
            background: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin-top: 10px;
        }

        .success-message {
            background: #E8F5E9;
            color: #4CAF50;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .success-message.show {
            display: flex;
        }

        .progress-info {
            background: #FFF3E0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
            text-align: center;
        }

        .dropdown-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #eee;
        }

        @media (max-width: 991px) {
            .content {
                flex-direction: column;
            }
            
            .map-section {
                border-right: none;
                border-bottom: 1px solid #eee;
                min-height: 400px;
            }
            
            .form-section {
                max-height: none;
                min-width: 100%;
            }
            
            .status-options {
                grid-template-columns: 1fr;
            }
            
            .dropdown-group {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            body {
                padding: 10px;
            }
            
            .form-section {
                padding: 15px;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #666;
        }
        
        .error-message {
            background: #FFEBEE;
            color: #C62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .config-section {
            background: #FFF3E0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #FFCC80;
        }
        
        .config-section h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #EF6C00;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìç Geotagging Usaha - Kabupaten Samosir</h1>
            <p>Ambil data dari Google Sheets ‚Üí Tandai Lokasi di Peta ‚Üí Simpan ke Google Sheets</p>
            <div class="data-counter" id="dataCount">Memuat data...</div>
        </header>

        <div class="content">
            <div class="map-section">
                <div class="map-controls">
                    <button class="btn btn-location" id="btnMyLocation">
                        üìç Gunakan Lokasi Saya
                    </button>
                    <div class="loading" id="mapLoading">Memuat peta...</div>
                </div>
                <div id="map"></div>
            </div>

            <div class="form-section">
                <div class="config-section">
                    <h3>‚öôÔ∏è Konfigurasi Google Sheets</h3>
                    <p>Data akan diambil dari Sheet ID Anda:</p>
                    <p><strong>121cp0i2z2U9eaBPMQuMWp1TGyDIcV42I9ptQ7cyT6B8</strong></p>
                    <p><small>Pastikan sheet memiliki kolom: <strong>A: Nama Usaha, B: Alamat, C: Kecamatan, D: Desa</strong></small></p>
                </div>

                <div class="instructions">
                    <strong>üìã Petunjuk Pengisian:</strong>
                    <ol>
                        <li>Pilih <strong>Kecamatan</strong> dari dropdown</li>
                        <li>Pilih <strong>Desa</strong> yang tersedia</li>
                        <li>Pilih <strong>Nama Usaha</strong> dari daftar</li>
                        <li>Alamat akan terisi otomatis</li>
                        <li><strong>Klik di peta</strong> untuk menentukan koordinat</li>
                        <li>Pilih status usaha</li>
                        <li>Klik <strong>"Simpan ke Google Sheets"</strong></li>
                        <li>Data langsung tersimpan online</li>
                    </ol>
                </div>

                <div class="progress-info" id="progressInfo">
                    Memuat data dari Google Sheets...
                </div>

                <div class="error-message" id="errorMessage"></div>

                <div class="success-message" id="successMessage">
                    <span style="font-size: 24px;">‚úÖ</span>
                    <div>
                        <strong>Data berhasil disimpan!</strong>
                        <div id="saveDetails" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="selectKecamatan">Kecamatan <span class="required">*</span></label>
                    <select id="selectKecamatan" required disabled>
                        <option value="">-- Pilih Kecamatan --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="selectDesa">Desa <span class="required">*</span></label>
                    <select id="selectDesa" required disabled>
                        <option value="">-- Pilih Desa --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="selectNamaUsaha">Nama Usaha <span class="required">*</span></label>
                    <select id="selectNamaUsaha" required disabled>
                        <option value="">-- Pilih Nama Usaha --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="alamat">Alamat (Terisi Otomatis)</label>
                    <textarea id="alamat" rows="2" readonly placeholder="Alamat akan muncul setelah memilih nama usaha"></textarea>
                    <small style="color: #666;">Alamat dari data Google Sheets</small>
                </div>

                <div class="form-group">
                    <label>Koordinat <span class="required">*</span></label>
                    <div class="coordinates-display">
                        Latitude: <span id="latDisplay">2.555500</span><br>
                        Longitude: <span id="lngDisplay">98.651900</span>
                    </div>
                    <small style="color: #666;">Klik di peta untuk mengatur koordinat</small>
                </div>

                <div class="form-group">
                    <label>Status Usaha <span class="required">*</span></label>
                    <div class="status-options">
                        <div class="status-option" data-status="Ditemukan">
                            ‚úÖ Ditemukan (Beroperasi)
                        </div>
                        <div class="status-option" data-status="Pindah">
                            üöö Pindah Lokasi
                        </div>
                        <div class="status-option" data-status="Tutup">
                            ‚ùå Tutup/Non-Aktif
                        </div>
                        <div class="status-option" data-status="Tidak Ditemukan">
                            üîç Tidak Ditemukan
                        </div>
                    </div>
                    <input type="hidden" id="status" value="" required>
                </div>

                <div class="form-group">
                    <label for="keterangan">Keterangan Tambahan</label>
                    <textarea id="keterangan" rows="3" placeholder="Catatan, kondisi usaha, atau informasi tambahan lainnya"></textarea>
                </div>

                <button class="btn btn-primary" id="btnSave" disabled>
                    üíæ Simpan ke Google Sheets
                </button>

                <button class="btn btn-secondary" id="btnReset">
                    üîÑ Form Baru
                </button>

                <button class="btn btn-secondary" id="btnReload">
                    üîÑ Muat Ulang Data
                </button>
            </div>
        </div>

        <footer>
            <p>Sistem Geotagging Usaha - Kabupaten Samosir | Data dari Google Sheets</p>
            <p>Sheet ID: 121cp0i2z2U9eaBPMQuMWp1TGyDIcV42I9ptQ7cyT6B8</p>
        </footer>
    </div>

    <!-- Google Maps API -->
    <script>
        // API Key untuk Google Maps
        const API_KEY = 'AIzaSyAOVYRIgupAurZup5y1PRh8Ismb1A3lLao';
        
        // URL Google Apps Script
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz88I4gSXC4fxQbTi_oxvWAZYOvltHE32Ov1WUm-3lA-17bTet5YJ8_JAYL-JtHQhRM/exec';
        
        // Google Sheet ID
        const SHEET_ID = '121cp0i2z2U9eaBPMQuMWp1TGyDIcV42I9ptQ7cyT6B8';
        
        // Load Google Maps
        function loadGoogleMaps() {
            return new Promise((resolve, reject) => {
                // Check if Google Maps is already loaded
                if (window.google && window.google.maps) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}`;
                script.async = true;
                script.defer = true;
                
                script.onload = () => {
                    console.log('Google Maps API loaded successfully');
                    resolve();
                };
                
                script.onerror = () => {
                    reject(new Error('Failed to load Google Maps API'));
                };
                
                document.head.appendChild(script);
            });
        }
        
        // Initialize the application
        async function initializeApp() {
            try {
                // Show loading
                document.getElementById('progressInfo').innerHTML = 'Memuat Google Maps...';
                document.getElementById('mapLoading').style.display = 'block';
                
                // Load Google Maps API
                await loadGoogleMaps();
                
                // Initialize the map
                initMap();
                
                // Load data from Google Sheets
                await loadDataFromGoogleSheets();
                
                // Initialize event listeners
                initEventListeners();
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showError(`Gagal memuat aplikasi: ${error.message}`);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

    <script>
        // ==================== VARIABEL GLOBAL ====================
        let map;
        let marker;
        let semuaDataUsaha = [];
        let dataUsahaTersedia = [];
        let dataTersimpanDiSheet = [];
        let selectedStatus = '';
        let currentLat = 2.5555;
        let currentLng = 98.6519;
        let isSaving = false;
        
        // ==================== INISIALISASI PETA ====================
        function initMap() {
            try {
                console.log('Initializing Google Maps...');
                
                // Koordinat default (Samosir)
                const defaultLocation = { lat: 2.5555, lng: 98.6519 };
                
                // Buat peta
                map = new google.maps.Map(document.getElementById('map'), {
                    center: defaultLocation,
                    zoom: 12,
                    mapTypeId: 'roadmap',
                    streetViewControl: false,
                    mapTypeControl: true,
                    fullscreenControl: true,
                    zoomControl: true,
                    gestureHandling: 'greedy'
                });
                
                // Buat marker
                marker = new google.maps.Marker({
                    position: defaultLocation,
                    map: map,
                    draggable: true,
                    title: "Lokasi usaha",
                    animation: google.maps.Animation.DROP
                });
                
                // Event: klik peta untuk pindahkan marker
                map.addListener('click', (event) => {
                    marker.setPosition(event.latLng);
                    updateCoordinates(event.latLng);
                });
                
                // Event: drag marker
                marker.addListener('dragend', () => {
                    updateCoordinates(marker.getPosition());
                });
                
                // Update tampilan koordinat
                updateCoordinates(defaultLocation);
                
                // Sembunyikan loading
                document.getElementById('mapLoading').style.display = 'none';
                
                console.log('Google Maps initialized successfully');
                
            } catch (error) {
                console.error('Error initializing map:', error);
                document.getElementById('mapLoading').innerHTML = 'Gagal memuat peta. Silakan refresh halaman.';
                showError(`Error memuat peta: ${error.message}`);
            }
        }
        
        // ==================== LOAD DATA DARI GOOGLE SHEETS ====================
        async function loadDataFromGoogleSheets() {
            try {
                showLoading(true);
                clearMessages();
                
                document.getElementById('progressInfo').innerHTML = 'Mengambil data dari Google Sheets...';
                
                // Fetch data dari Google Apps Script
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getData&sheetId=${SHEET_ID}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                console.log('Data dari Google Sheets:', data);
                
                // Proses data
                processData(data);
                
                // Load data geotag yang sudah tersimpan
                await loadGeotagData();
                
                // Update UI
                updateDropdownKecamatan();
                updateProgressInfo();
                enableForm();
                
                showSuccess(`Data berhasil dimuat: ${semuaDataUsaha.length} usaha ditemukan`);
                
            } catch (error) {
                console.error('Error loading data from Google Sheets:', error);
                showError(`Gagal memuat data: ${error.message}<br>Pastikan sheet memiliki kolom: Nama Usaha, Alamat, Kecamatan, Desa`);
            } finally {
                showLoading(false);
            }
        }
        
        function processData(rawData) {
            if (!rawData || rawData.length === 0) {
                showError('Data tidak ditemukan di Google Sheets.');
                return;
            }
            
            // Filter dan bersihkan data
            semuaDataUsaha = rawData
                .filter(row => row.namaUsaha && row.kecamatan && row.desa)
                .map(row => ({
                    nama: row.namaUsaha.toString().trim(),
                    alamat: (row.alamat || '').toString().trim(),
                    kecamatan: row.kecamatan.toString().trim(),
                    desa: row.desa.toString().trim(),
                    kdkec: row.kdkec || '',
                    kddesa: row.kddesa || ''
                }));
            
            if (semuaDataUsaha.length === 0) {
                showError('Data kosong atau format tidak sesuai.');
                return;
            }
            
            console.log('Data diproses:', semuaDataUsaha.length, 'usaha');
        }
        
        // ==================== LOAD DATA GEOTAG YANG SUDAH DISIMPAN ====================
        async function loadGeotagData() {
            try {
                // Mengambil data yang sudah disimpan dari Google Sheets
                // Kita asumsikan ada endpoint lain untuk mengambil data geotag
                // Untuk sementara, kita gunakan localStorage sebagai cache
                const savedData = JSON.parse(localStorage.getItem('geotagDataSamosir') || '[]');
                dataTersimpanDiSheet = savedData;
                
                // Filter data yang belum di-geotag
                const namaUsahaTersimpan = new Set(savedData.map(item => item.namaUsaha));
                dataUsahaTersedia = semuaDataUsaha.filter(usaha => 
                    !namaUsahaTersimpan.has(usaha.nama)
                );
                
                console.log('Data tersedia:', dataUsahaTersedia.length, 'dari', semuaDataUsaha.length);
                
            } catch (error) {
                console.error('Error loading geotag data:', error);
                // Jika error, anggap semua data tersedia
                dataUsahaTersedia = [...semuaDataUsaha];
                dataTersimpanDiSheet = [];
            }
        }
        
        // ==================== EVENT LISTENERS ====================
        function initEventListeners() {
            // Kecamatan change
            document.getElementById('selectKecamatan').addEventListener('change', function() {
                const kecamatan = this.value;
                if (!kecamatan) {
                    resetDropdownDesa();
                    return;
                }
                
                // Filter desa berdasarkan kecamatan
                const desaList = [...new Set(
                    dataUsahaTersedia
                        .filter(item => item.kecamatan === kecamatan)
                        .map(item => item.desa)
                )];
                
                desaList.sort();
                
                const selectDesa = document.getElementById('selectDesa');
                selectDesa.innerHTML = '<option value="">-- Pilih Desa --</option>';
                
                desaList.forEach(desa => {
                    const option = document.createElement('option');
                    option.value = desa;
                    option.textContent = desa;
                    selectDesa.appendChild(option);
                });
                
                selectDesa.disabled = false;
                resetDropdownNamaUsaha();
            });
            
            // Desa change
            document.getElementById('selectDesa').addEventListener('change', function() {
                const kecamatan = document.getElementById('selectKecamatan').value;
                const desa = this.value;
                
                if (!desa) {
                    resetDropdownNamaUsaha();
                    return;
                }
                
                // Filter nama usaha
                const usahaList = dataUsahaTersedia.filter(item => 
                    item.kecamatan === kecamatan && item.desa === desa
                );
                
                usahaList.sort((a, b) => a.nama.localeCompare(b.nama));
                
                const selectNamaUsaha = document.getElementById('selectNamaUsaha');
                selectNamaUsaha.innerHTML = '<option value="">-- Pilih Nama Usaha --</option>';
                
                usahaList.forEach(usaha => {
                    const option = document.createElement('option');
                    option.value = usaha.nama;
                    option.textContent = usaha.nama;
                    option.setAttribute('data-alamat', usaha.alamat);
                    selectNamaUsaha.appendChild(option);
                });
                
                selectNamaUsaha.disabled = false;
            });
            
            // Nama usaha change
            document.getElementById('selectNamaUsaha').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const alamat = selectedOption.getAttribute('data-alamat') || '';
                document.getElementById('alamat').value = alamat;
            });
            
            // Status selection
            document.querySelectorAll('.status-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.status-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    option.classList.add('selected');
                    selectedStatus = option.getAttribute('data-status');
                    document.getElementById('status').value = selectedStatus;
                });
            });
            
            // Simpan data
            document.getElementById('btnSave').addEventListener('click', saveDataToGoogleSheets);
            
            // Reset form
            document.getElementById('btnReset').addEventListener('click', resetForm);
            
            // Reload data
            document.getElementById('btnReload').addEventListener('click', async () => {
                if (confirm('Muat ulang data dari Google Sheets?')) {
                    await loadDataFromGoogleSheets();
                }
            });
            
            // Lokasi saya
            document.getElementById('btnMyLocation').addEventListener('click', getMyLocation);
        }
        
        // ==================== FUNGSI UTAMA ====================
        function updateCoordinates(latlng) {
            currentLat = latlng.lat();
            currentLng = latlng.lng();
            
            document.getElementById('latDisplay').textContent = currentLat.toFixed(6);
            document.getElementById('lngDisplay').textContent = currentLng.toFixed(6);
        }
        
        function getMyLocation() {
            if (!navigator.geolocation) {
                alert('Browser tidak mendukung geolocation');
                return;
            }
            
            document.getElementById('mapLoading').style.display = 'block';
            document.getElementById('mapLoading').textContent = 'Mendapatkan lokasi...';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (map && marker) {
                        map.setCenter(userLocation);
                        map.setZoom(16);
                        marker.setPosition(userLocation);
                        updateCoordinates(userLocation);
                    }
                    
                    document.getElementById('mapLoading').style.display = 'none';
                },
                (error) => {
                    alert('Tidak dapat mengakses lokasi. Pastikan izin lokasi diaktifkan.');
                    document.getElementById('mapLoading').style.display = 'none';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        async function saveDataToGoogleSheets() {
            if (isSaving) return;
            
            // Validasi
            const namaUsaha = document.getElementById('selectNamaUsaha').value.trim();
            const kecamatan = document.getElementById('selectKecamatan').value.trim();
            const desa = document.getElementById('selectDesa').value.trim();
            
            if (!namaUsaha || !kecamatan || !desa || !selectedStatus) {
                alert('Harap lengkapi semua field yang wajib diisi (bertanda *)');
                return;
            }
            
            // Cari data asli
            const dataAsli = semuaDataUsaha.find(item => 
                item.nama === namaUsaha && 
                item.kecamatan === kecamatan && 
                item.desa === desa
            );
            
            if (!dataAsli) {
                alert('Data tidak ditemukan!');
                return;
            }
            
            // Buat data geotag
            const geotagData = {
                sheetId: SHEET_ID,
                namaUsaha: namaUsaha,
                alamat: document.getElementById('alamat').value.trim(),
                kecamatan: kecamatan,
                desa: desa,
                kdkec: dataAsli.kdkec || '',
                kddesa: dataAsli.kddesa || '',
                latitude: currentLat,
                longitude: currentLng,
                status: selectedStatus,
                keterangan: document.getElementById('keterangan').value.trim(),
                tanggal: new Date().toISOString()
            };
            
            // Set status saving
            isSaving = true;
            const saveBtn = document.getElementById('btnSave');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Menyimpan...';
            saveBtn.disabled = true;
            
            try {
                // Kirim data ke Google Apps Script
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(geotagData)
                });
                
                // Karena mode 'no-cors', kita tidak bisa membaca response
                // Tampilkan pesan sukses
                showSuccess(`Data "${namaUsaha}" berhasil disimpan ke Google Sheets!`);
                
                // Simpan ke cache lokal
                dataTersimpanDiSheet.push(geotagData);
                localStorage.setItem('geotagDataSamosir', JSON.stringify(dataTersimpanDiSheet));
                
                // Hapus dari data tersedia
                const indexToRemove = dataUsahaTersedia.findIndex(item => 
                    item.nama === namaUsaha && 
                    item.kecamatan === kecamatan && 
                    item.desa === desa
                );
                
                if (indexToRemove !== -1) {
                    dataUsahaTersedia.splice(indexToRemove, 1);
                }
                
                // Update UI
                updateDropdownKecamatan();
                updateProgressInfo();
                
                // Reset form
                resetFormPartial();
                
                // Auto-select kecamatan/desa yang sama jika masih ada data
                autoSelectNext();
                
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                showError('Gagal menyimpan data. Periksa koneksi internet.');
            } finally {
                // Reset button state
                isSaving = false;
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }
        
        // ==================== FUNGSI UI ====================
        function updateDropdownKecamatan() {
            const select = document.getElementById('selectKecamatan');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">-- Pilih Kecamatan --</option>';
            
            // Ambil kecamatan unik dari data tersedia
            const kecamatanList = [...new Set(dataUsahaTersedia.map(item => item.kecamatan))];
            kecamatanList.sort();
            
            kecamatanList.forEach(kecamatan => {
                const option = document.createElement('option');
                option.value = kecamatan;
                option.textContent = kecamatan;
                select.appendChild(option);
            });
            
            // Restore selection jika masih ada
            if (currentValue && kecamatanList.includes(currentValue)) {
                select.value = currentValue;
                triggerEvent(select, 'change');
            }
            
            resetDropdownDesa();
            
            // Enable/disable select berdasarkan ketersediaan data
            select.disabled = kecamatanList.length === 0;
        }
        
        function resetDropdownDesa() {
            const select = document.getElementById('selectDesa');
            select.innerHTML = '<option value="">-- Pilih Desa --</option>';
            select.disabled = true;
            resetDropdownNamaUsaha();
        }
        
        function resetDropdownNamaUsaha() {
            const select = document.getElementById('selectNamaUsaha');
            select.innerHTML = '<option value="">-- Pilih Nama Usaha --</option>';
            select.disabled = true;
            document.getElementById('alamat').value = '';
        }
        
        function updateProgressInfo() {
            const total = semuaDataUsaha.length;
            const tersimpan = dataTersimpanDiSheet.length;
            const tersedia = dataUsahaTersedia.length;
            
            document.getElementById('progressInfo').innerHTML = `
                <strong>Progress: ${tersimpan}/${total} data</strong><br>
                <small>${tersedia} data belum di-geotag | ${tersimpan} sudah disimpan</small>
            `;
            
            document.getElementById('dataCount').textContent = 
                `Data tersimpan: ${tersimpan} | Sisa data: ${tersedia}`;
        }
        
        function enableForm() {
            const hasData = dataUsahaTersedia.length > 0;
            document.getElementById('btnSave').disabled = !hasData;
            document.getElementById('selectKecamatan').disabled = !hasData;
            
            if (!hasData) {
                document.getElementById('progressInfo').innerHTML += 
                    '<br><small style="color: #4CAF50;">Semua data sudah di-geotag!</small>';
            }
        }
        
        function showLoading(isLoading) {
            const progressInfo = document.getElementById('progressInfo');
            if (isLoading) {
                progressInfo.innerHTML = 'Memuat data...';
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `‚ö†Ô∏è ${message}`;
            errorDiv.style.display = 'block';
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const saveDetails = document.getElementById('saveDetails');
            
            saveDetails.innerHTML = message;
            successDiv.classList.add('show');
            
            setTimeout(() => {
                successDiv.classList.remove('show');
            }, 5000);
        }
        
        function clearMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').classList.remove('show');
        }
        
        function resetFormPartial() {
            document.getElementById('keterangan').value = '';
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            selectedStatus = '';
            document.getElementById('status').value = '';
            resetDropdownNamaUsaha();
        }
        
        function autoSelectNext() {
            const currentKecamatan = document.getElementById('selectKecamatan').value;
            const currentDesa = document.getElementById('selectDesa').value;
            
            if (!currentKecamatan || !currentDesa) return;
            
            // Cek apakah masih ada usaha di desa yang sama
            const sisaUsaha = dataUsahaTersedia.filter(item => 
                item.kecamatan === currentKecamatan && item.desa === currentDesa
            );
            
            if (sisaUsaha.length === 0) {
                // Reset desa jika tidak ada usaha lagi
                resetDropdownDesa();
            }
        }
        
        function resetForm() {
            if (confirm('Reset form ke kondisi awal?')) {
                document.getElementById('selectKecamatan').selectedIndex = 0;
                document.getElementById('selectDesa').selectedIndex = 0;
                document.getElementById('selectDesa').disabled = true;
                document.getElementById('selectNamaUsaha').selectedIndex = 0;
                document.getElementById('selectNamaUsaha').disabled = true;
                document.getElementById('alamat').value = '';
                document.getElementById('keterangan').value = '';
                
                document.querySelectorAll('.status-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                selectedStatus = '';
                document.getElementById('status').value = '';
                
                // Reset peta ke lokasi default
                if (map && marker) {
                    const defaultLocation = { lat: 2.5555, lng: 98.6519 };
                    map.setCenter(defaultLocation);
                    map.setZoom(12);
                    marker.setPosition(defaultLocation);
                    updateCoordinates(defaultLocation);
                }
                
                // Hide success message
                document.getElementById('successMessage').classList.remove('show');
            }
        }
        
        // Helper function
        function triggerEvent(element, eventName) {
            const event = new Event(eventName, {
                bubbles: true,
                cancelable: true
            });
            element.dispatchEvent(event);
        }
        
        // Handle Google Maps API error
        window.gm_authFailure = function() {
            const errorMessage = 'Google Maps API key tidak valid atau quota habis.';
            document.getElementById('mapLoading').innerHTML = errorMessage;
            showError(errorMessage);
        };
    </script>
</body>
</html>

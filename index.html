<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geotagging Usaha - Data Samosir</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f5f5f5;
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #2196F3, #1976D2);
            color: white;
            padding: 20px;
            text-align: center;
        }

        header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        @media (min-width: 992px) {
            .content {
                flex-direction: row;
            }
        }

        .map-section {
            flex: 1;
            min-height: 500px;
            border-right: 1px solid #eee;
        }

        .form-section {
            flex: 1;
            min-width: 400px;
            padding: 20px;
            overflow-y: auto;
            max-height: 700px;
        }

        #map {
            width: 100%;
            height: 500px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2196F3;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .coordinates-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
            border: 1px solid #ddd;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #757575;
            color: white;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #616161;
        }

        .btn-location {
            background: #2196F3;
            color: white;
            margin-top: 10px;
        }

        .btn-location:hover {
            background: #1976D2;
        }

        .map-controls {
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid #eee;
        }

        .status-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .status-option {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            font-weight: 500;
        }

        .status-option:hover {
            border-color: #2196F3;
        }

        .status-option.selected {
            border-color: #4CAF50;
            background: #E8F5E9;
        }

        .status-option[data-status="Ditemukan"] {
            color: #4CAF50;
        }

        .status-option[data-status="Pindah"] {
            color: #FF9800;
        }

        .status-option[data-status="Tutup"] {
            color: #F44336;
        }

        .status-option[data-status="Tidak Ditemukan"] {
            color: #9E9E9E;
        }

        .required {
            color: #F44336;
        }

        .instructions {
            background: #E3F2FD;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.5;
        }

        .instructions ol {
            padding-left: 20px;
            margin-top: 5px;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        .data-counter {
            background: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin-top: 10px;
        }

        .success-message {
            background: #E8F5E9;
            color: #4CAF50;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .success-message.show {
            display: flex;
        }

        .progress-info {
            background: #FFF3E0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
            text-align: center;
        }

        footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #eee;
        }

        @media (max-width: 991px) {
            .content {
                flex-direction: column;
            }
            
            .map-section {
                border-right: none;
                border-bottom: 1px solid #eee;
                min-height: 400px;
            }
            
            .form-section {
                max-height: none;
                min-width: 100%;
            }
            
            .status-options {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            body {
                padding: 10px;
            }
            
            .form-section {
                padding: 15px;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #666;
        }
        
        .error-message {
            background: #FFEBEE;
            color: #C62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìç Geotagging Usaha - Kabupaten Samosir</h1>
            <p>Data dari Google Sheets ‚Üí Tandai Lokasi di Peta ‚Üí Simpan ke Google Sheets</p>
            <div class="data-counter" id="dataCount">Memuat data...</div>
        </header>

        <div class="content">
            <div class="map-section">
                <div class="map-controls">
                    <button class="btn btn-location" id="btnMyLocation">
                        üìç Gunakan Lokasi Saya
                    </button>
                    <div class="loading" id="mapLoading">Memuat peta...</div>
                </div>
                <div id="map"></div>
            </div>

            <div class="form-section">
                <div class="instructions">
                    <strong>üìã Petunjuk Pengisian:</strong>
                    <ol>
                        <li>Pilih <strong>Kecamatan</strong> dari dropdown</li>
                        <li>Pilih <strong>Desa</strong> yang tersedia</li>
                        <li>Pilih <strong>Nama Usaha</strong> dari daftar</li>
                        <li>Alamat akan terisi otomatis</li>
                        <li><strong>Klik di peta</strong> untuk menentukan koordinat</li>
                        <li>Pilih status usaha</li>
                        <li>Klik <strong>"Simpan ke Google Sheets"</strong></li>
                        <li>Data langsung tersimpan di sheet DataGeotag</li>
                    </ol>
                </div>

                <div class="progress-info" id="progressInfo">
                    Memuat data dari Google Sheets...
                </div>

                <div class="error-message" id="errorMessage"></div>

                <div class="success-message" id="successMessage">
                    <span style="font-size: 24px;">‚úÖ</span>
                    <div>
                        <strong>Data berhasil disimpan!</strong>
                        <div id="saveDetails" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="selectKecamatan">Kecamatan <span class="required">*</span></label>
                    <select id="selectKecamatan" required disabled>
                        <option value="">-- Pilih Kecamatan --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="selectDesa">Desa <span class="required">*</span></label>
                    <select id="selectDesa" required disabled>
                        <option value="">-- Pilih Desa --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="selectNamaUsaha">Nama Usaha <span class="required">*</span></label>
                    <select id="selectNamaUsaha" required disabled>
                        <option value="">-- Pilih Nama Usaha --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="alamat">Alamat (Terisi Otomatis)</label>
                    <textarea id="alamat" rows="2" readonly placeholder="Alamat akan muncul setelah memilih nama usaha"></textarea>
                </div>

                <div class="form-group">
                    <label>Koordinat <span class="required">*</span></label>
                    <div class="coordinates-display">
                        Latitude: <span id="latDisplay">2.555500</span><br>
                        Longitude: <span id="lngDisplay">98.651900</span>
                    </div>
                    <small style="color: #666;">Klik di peta untuk mengatur koordinat</small>
                </div>

                <div class="form-group">
                    <label>Status Usaha <span class="required">*</span></label>
                    <div class="status-options">
                        <div class="status-option" data-status="Ditemukan">
                            ‚úÖ Ditemukan
                        </div>
                        <div class="status-option" data-status="Pindah">
                            üöö Pindah
                        </div>
                        <div class="status-option" data-status="Tutup">
                            ‚ùå Tutup
                        </div>
                        <div class="status-option" data-status="Tidak Ditemukan">
                            üîç Tidak Ditemukan
                        </div>
                    </div>
                    <input type="hidden" id="status" value="" required>
                </div>

                <div class="form-group">
                    <label for="keterangan">Keterangan Tambahan</label>
                    <textarea id="keterangan" rows="3" placeholder="Catatan, kondisi usaha, atau informasi tambahan lainnya"></textarea>
                </div>

                <button class="btn btn-primary" id="btnSave" disabled>
                    üíæ Simpan ke Google Sheets
                </button>

                <button class="btn btn-secondary" id="btnReset">
                    üîÑ Form Baru
                </button>

                <button class="btn btn-secondary" id="btnReload">
                    üîÑ Muat Ulang Data
                </button>
            </div>
        </div>

        <footer>
            <p>Sistem Geotagging Usaha - Kabupaten Samosir | Data dari Google Sheets</p>
            <p>Sheet ID: 121cp0i2z2U9eaBPMQuMWp1TGyDIcV42I9ptQ7cyT6B8</p>
        </footer>
    </div>

    <!-- Google Maps API -->
    <script>
        // API Key untuk Google Maps
        const API_KEY = 'AIzaSyAOVYRIgupAurZup5y1PRh8Ismb1A3lLao';
        
        // URL Google Apps Script - Gunakan proxy untuk menghindari CORS
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz88I4gSXC4fxQbTi_oxvWAZYOvltHE32Ov1WUm-3lA-17bTet5YJ8_JAYL-JtHQhRM/exec';
        
        // Google Sheet ID
        const SHEET_ID = '121cp0i2z2U9eaBPMQuMWp1TGyDIcV42I9ptQ7cyT6B8';
        
        // Load Google Maps
        function loadGoogleMaps() {
            return new Promise((resolve, reject) => {
                if (window.google && window.google.maps) {
                    console.log('Google Maps sudah dimuat');
                    resolve();
                    return;
                }
                
                console.log('Memuat Google Maps API...');
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}`;
                script.async = true;
                script.defer = true;
                
                script.onload = () => {
                    console.log('Google Maps API berhasil dimuat');
                    resolve();
                };
                
                script.onerror = () => {
                    console.error('Gagal memuat Google Maps API');
                    reject(new Error('Gagal memuat Google Maps API'));
                };
                
                document.head.appendChild(script);
            });
        }
        
        // Initialize the application
        async function initializeApp() {
            try {
                console.log('Menginisialisasi aplikasi...');
                
                document.getElementById('progressInfo').innerHTML = 'Memuat peta dan data...';
                document.getElementById('mapLoading').style.display = 'block';
                
                await loadGoogleMaps();
                initMap();
                await loadDataFromGoogleSheets();
                initEventListeners();
                
                console.log('Aplikasi berhasil diinisialisasi');
                
            } catch (error) {
                console.error('Error menginisialisasi aplikasi:', error);
                showError(`Gagal memuat aplikasi: ${error.message}`);
                
                const mapLoading = document.getElementById('mapLoading');
                mapLoading.style.display = 'block';
                mapLoading.textContent = 'Gagal memuat peta. Silakan refresh halaman.';
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

    <script>
        // ==================== VARIABEL GLOBAL ====================
        let map;
        let marker;
        let semuaDataUsaha = [];
        let dataUsahaTersedia = [];
        let dataTersimpanDiSheet = [];
        let selectedStatus = '';
        let currentLat = 2.5555;
        let currentLng = 98.6519;
        let isSaving = false;
        
        // ==================== INISIALISASI PETA ====================
        function initMap() {
            try {
                console.log('Menginisialisasi peta Google Maps...');
                
                const defaultLocation = { lat: 2.5555, lng: 98.6519 };
                
                map = new google.maps.Map(document.getElementById('map'), {
                    center: defaultLocation,
                    zoom: 12,
                    mapTypeId: 'hybrid',
                    streetViewControl: true,
                    mapTypeControl: true,
                    fullscreenControl: true,
                    zoomControl: true,
                    gestureHandling: 'greedy',
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                        position: google.maps.ControlPosition.TOP_RIGHT,
                        mapTypeIds: ['roadmap', 'satellite', 'hybrid', 'terrain']
                    }
                });
                
                marker = new google.maps.Marker({
                    position: defaultLocation,
                    map: map,
                    draggable: true,
                    title: "Lokasi usaha",
                    animation: google.maps.Animation.DROP,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    }
                });
                
                map.addListener('click', (event) => {
                    marker.setPosition(event.latLng);
                    updateCoordinates(event.latLng);
                });
                
                marker.addListener('dragend', () => {
                    updateCoordinates(marker.getPosition());
                });
                
                updateCoordinates(defaultLocation);
                document.getElementById('mapLoading').style.display = 'none';
                
                console.log('Peta Google Maps berhasil diinisialisasi');
                
            } catch (error) {
                console.error('Error menginisialisasi peta:', error);
                const mapLoading = document.getElementById('mapLoading');
                mapLoading.style.display = 'block';
                mapLoading.textContent = 'Error menginisialisasi peta: ' + error.message;
                showError(`Error memuat peta: ${error.message}`);
            }
        }
        
        // ==================== FUNGSI UPDATE COORDINATES YANG AMAN ====================
        function updateCoordinates(latlng) {
            try {
                // Handle both google.maps.LatLng object and plain object
                if (typeof latlng.lat === 'function') {
                    // It's a google.maps.LatLng object
                    currentLat = latlng.lat();
                    currentLng = latlng.lng();
                } else {
                    // It's a plain object
                    currentLat = latlng.lat;
                    currentLng = latlng.lng;
                }
                
                document.getElementById('latDisplay').textContent = currentLat.toFixed(6);
                document.getElementById('lngDisplay').textContent = currentLng.toFixed(6);
                
            } catch (error) {
                console.error('Error updating coordinates:', error);
            }
        }
        
        // ==================== LOAD DATA DARI GOOGLE SHEETS ====================
        async function loadDataFromGoogleSheets() {
            try {
                showLoading(true);
                clearMessages();
                
                document.getElementById('progressInfo').innerHTML = 'Mengambil data dari Google Sheets...';
                
                // Menggunakan Google Apps Script Web App untuk menghindari CORS
                // GET request tidak memerlukan preflight, jadi lebih aman dari CORS
                const dataAwalUrl = `${APPS_SCRIPT_URL}?action=getDataAwal&sheetId=${SHEET_ID}&callback=getDataCallback`;
                console.log('Mengambil data awal dari:', dataAwalUrl);
                
                // Load script dengan callback untuk menghindari CORS
                await loadWithJSONP(dataAwalUrl);
                
            } catch (error) {
                console.error('Error loading data from Google Sheets:', error);
                showError(`Gagal memuat data: ${error.message}`);
                showLoading(false);
            }
        }
        
        // ==================== JSONP HELPER UNTUK MENGHINDARI CORS ====================
        function loadWithJSONP(url) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonpCallback_' + Date.now();
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                const script = document.createElement('script');
                script.src = url.replace('callback=getDataCallback', `callback=${callbackName}`);
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                
                document.body.appendChild(script);
            });
        }
        
        // Callback function untuk JSONP
        window.getDataCallback = function(data) {
            console.log('Data diterima via JSONP:', data);
            processData(data);
            loadGeotagData();
        };
        
        function processData(rawData) {
            if (!rawData || rawData.length === 0) {
                showError('Data tidak ditemukan di sheet DataAwal.');
                return;
            }
            
            // Proses data awal dari sheet DataAwal
            semuaDataUsaha = rawData
                .filter(row => row.namaUsaha && row.kecamatan && row.desa)
                .map(row => ({
                    nama: row.namaUsaha.toString().trim(),
                    alamat: (row.alamat || '').toString().trim(),
                    kecamatan: row.kecamatan.toString().trim(),
                    desa: row.desa.toString().trim(),
                    kdkec: row.kdkec || '',
                    kddesa: row.kddesa || ''
                }));
            
            if (semuaDataUsaha.length === 0) {
                showError('Data kosong atau format tidak sesuai di sheet DataAwal.');
                return;
            }
            
            console.log('Data diproses:', semuaDataUsaha.length, 'usaha');
        }
        
        async function loadGeotagData() {
            try {
                // Menggunakan JSONP untuk get data juga
                const dataGeotagUrl = `${APPS_SCRIPT_URL}?action=getDataGeotag&sheetId=${SHEET_ID}&callback=getGeotagCallback`;
                const script = document.createElement('script');
                script.src = dataGeotagUrl;
                document.body.appendChild(script);
                
            } catch (error) {
                console.error('Error loading geotag data:', error);
                dataTersimpanDiSheet = [];
                filterDataTersedia();
                updateUI();
            }
        }
        
        // Callback untuk data geotag
        window.getGeotagCallback = function(data) {
            console.log('Data geotag diterima:', data.length, 'baris');
            dataTersimpanDiSheet = data;
            filterDataTersedia();
            updateUI();
        };
        
        function filterDataTersedia() {
            const namaUsahaTersimpan = new Set(dataTersimpanDiSheet.map(item => item.namaUsaha));
            dataUsahaTersedia = semuaDataUsaha.filter(usaha => 
                !namaUsahaTersimpan.has(usaha.nama)
            );
            
            console.log('Data tersedia:', dataUsahaTersedia.length, 'dari', semuaDataUsaha.length);
        }
        
        function updateUI() {
            updateDropdownKecamatan();
            updateProgressInfo();
            enableForm();
            showSuccess(`Data berhasil dimuat: ${semuaDataUsaha.length} usaha ditemukan`);
            showLoading(false);
        }
        
        // ==================== EVENT LISTENERS ====================
        function initEventListeners() {
            document.getElementById('selectKecamatan').addEventListener('change', function() {
                const kecamatan = this.value;
                if (!kecamatan) {
                    resetDropdownDesa();
                    return;
                }
                
                const desaList = [...new Set(
                    dataUsahaTersedia
                        .filter(item => item.kecamatan === kecamatan)
                        .map(item => item.desa)
                )];
                
                desaList.sort();
                
                const selectDesa = document.getElementById('selectDesa');
                selectDesa.innerHTML = '<option value="">-- Pilih Desa --</option>';
                
                desaList.forEach(desa => {
                    const option = document.createElement('option');
                    option.value = desa;
                    option.textContent = desa;
                    selectDesa.appendChild(option);
                });
                
                selectDesa.disabled = false;
                resetDropdownNamaUsaha();
            });
            
            document.getElementById('selectDesa').addEventListener('change', function() {
                const kecamatan = document.getElementById('selectKecamatan').value;
                const desa = this.value;
                
                if (!desa) {
                    resetDropdownNamaUsaha();
                    return;
                }
                
                const usahaList = dataUsahaTersedia.filter(item => 
                    item.kecamatan === kecamatan && item.desa === desa
                );
                
                usahaList.sort((a, b) => a.nama.localeCompare(b.nama));
                
                const selectNamaUsaha = document.getElementById('selectNamaUsaha');
                selectNamaUsaha.innerHTML = '<option value="">-- Pilih Nama Usaha --</option>';
                
                usahaList.forEach(usaha => {
                    const option = document.createElement('option');
                    option.value = usaha.nama;
                    option.textContent = usaha.nama;
                    option.setAttribute('data-alamat', usaha.alamat);
                    selectNamaUsaha.appendChild(option);
                });
                
                selectNamaUsaha.disabled = false;
            });
            
            document.getElementById('selectNamaUsaha').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const alamat = selectedOption.getAttribute('data-alamat') || '';
                document.getElementById('alamat').value = alamat;
            });
            
            document.querySelectorAll('.status-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.status-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    option.classList.add('selected');
                    selectedStatus = option.getAttribute('data-status');
                    document.getElementById('status').value = selectedStatus;
                });
            });
            
            document.getElementById('btnSave').addEventListener('click', saveDataToGoogleSheets);
            document.getElementById('btnReset').addEventListener('click', resetForm);
            document.getElementById('btnReload').addEventListener('click', async () => {
                if (confirm('Muat ulang data dari Google Sheets?')) {
                    await loadDataFromGoogleSheets();
                }
            });
            
            document.getElementById('btnMyLocation').addEventListener('click', getMyLocation);
        }
        
        // ==================== FUNGSI UTAMA ====================
        function getMyLocation() {
            if (!navigator.geolocation) {
                alert('Browser tidak mendukung geolocation');
                return;
            }
            
            const mapLoading = document.getElementById('mapLoading');
            mapLoading.style.display = 'block';
            mapLoading.textContent = 'Mendapatkan lokasi...';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (map && marker) {
                        map.setCenter(userLocation);
                        map.setZoom(16);
                        marker.setPosition(userLocation);
                        updateCoordinates(userLocation);
                    }
                    
                    mapLoading.style.display = 'none';
                },
                (error) => {
                    alert('Tidak dapat mengakses lokasi. Pastikan izin lokasi diaktifkan.');
                    mapLoading.style.display = 'none';
                }
            );
        }
        
        // ==================== FUNGSI SIMPAN DENGAN FORM SUBMIT UNTUK HINDARI CORS ====================
        async function saveDataToGoogleSheets() {
            if (isSaving) return;
            
            const namaUsaha = document.getElementById('selectNamaUsaha').value.trim();
            const kecamatan = document.getElementById('selectKecamatan').value.trim();
            const desa = document.getElementById('selectDesa').value.trim();
            
            if (!namaUsaha || !kecamatan || !desa || !selectedStatus) {
                alert('Harap lengkapi semua field yang wajib diisi (bertanda *)');
                return;
            }
            
            const dataAsli = semuaDataUsaha.find(item => 
                item.nama === namaUsaha && 
                item.kecamatan === kecamatan && 
                item.desa === desa
            );
            
            if (!dataAsli) {
                alert('Data tidak ditemukan di DataAwal!');
                return;
            }
            
            // Buat data untuk disimpan
            const geotagData = {
                sheetId: SHEET_ID,
                namaUsaha: namaUsaha,
                alamat: document.getElementById('alamat').value.trim(),
                kecamatan: kecamatan,
                desa: desa,
                kdkec: dataAsli.kdkec || '',
                kddesa: dataAsli.kddesa || '',
                latitude: currentLat,
                longitude: currentLng,
                status: selectedStatus,
                keterangan: document.getElementById('keterangan').value.trim(),
                tanggal: new Date().toISOString()
            };
            
            // Set status saving
            isSaving = true;
            const saveBtn = document.getElementById('btnSave');
            saveBtn.classList.add('btn-disabled');
            saveBtn.disabled = true;
            
            try {
                // Menggunakan form submit untuk menghindari CORS pada POST
                await saveWithFormSubmit(geotagData);
                
                // Jika berhasil, update UI
                dataTersimpanDiSheet.push(geotagData);
                
                // Hapus dari data tersedia
                const indexToRemove = dataUsahaTersedia.findIndex(item => 
                    item.nama === namaUsaha && 
                    item.kecamatan === kecamatan && 
                    item.desa === desa
                );
                
                if (indexToRemove !== -1) {
                    dataUsahaTersedia.splice(indexToRemove, 1);
                }
                
                // Update UI
                updateDropdownKecamatan();
                updateProgressInfo();
                
                // Reset form
                resetFormPartial();
                
                // Auto-select kecamatan/desa yang sama jika masih ada data
                autoSelectNext();
                
                showSuccess(`Data "${namaUsaha}" berhasil disimpan!`);
                
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                showError('Gagal menyimpan data. Periksa koneksi internet.');
            } finally {
                isSaving = false;
                saveBtn.classList.remove('btn-disabled');
                saveBtn.disabled = false;
            }
        }
        
        // ==================== FUNGSI FORM SUBMIT UNTUK HINDARI CORS ====================
        function saveWithFormSubmit(data) {
            return new Promise((resolve, reject) => {
                // Buat form tersembunyi
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hiddenFrame';
                form.style.display = 'none';
                
                // Buat iframe untuk response
                const iframe = document.createElement('iframe');
                iframe.name = 'hiddenFrame';
                iframe.style.display = 'none';
                
                // Tambahkan input fields ke form
                Object.keys(data).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = data[key];
                    form.appendChild(input);
                });
                
                // Handle response
                iframe.onload = function() {
                    try {
                        // Coba baca response dari iframe
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const responseText = iframeDoc.body.textContent || iframeDoc.body.innerText;
                        
                        // Hapus form dan iframe
                        document.body.removeChild(form);
                        document.body.removeChild(iframe);
                        
                        if (responseText.includes('success') || responseText.includes('Data berhasil')) {
                            resolve();
                        } else {
                            reject(new Error('Failed to save data'));
                        }
                    } catch (e) {
                        // Jika tidak bisa membaca response, anggap berhasil
                        document.body.removeChild(form);
                        document.body.removeChild(iframe);
                        resolve();
                    }
                };
                
                // Tambahkan ke body dan submit
                document.body.appendChild(iframe);
                document.body.appendChild(form);
                form.submit();
                
                // Timeout fallback
                setTimeout(() => {
                    if (document.body.contains(form)) {
                        document.body.removeChild(form);
                    }
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                    resolve(); // Anggap berhasil setelah timeout
                }, 5000);
            });
        }
        
        // ==================== FUNGSI UI ====================
        function updateDropdownKecamatan() {
            const select = document.getElementById('selectKecamatan');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">-- Pilih Kecamatan --</option>';
            
            const kecamatanList = [...new Set(dataUsahaTersedia.map(item => item.kecamatan))];
            kecamatanList.sort();
            
            kecamatanList.forEach(kecamatan => {
                const option = document.createElement('option');
                option.value = kecamatan;
                option.textContent = kecamatan;
                select.appendChild(option);
            });
            
            if (currentValue && kecamatanList.includes(currentValue)) {
                select.value = currentValue;
                triggerEvent(select, 'change');
            }
            
            resetDropdownDesa();
            select.disabled = kecamatanList.length === 0;
        }
        
        function resetDropdownDesa() {
            const select = document.getElementById('selectDesa');
            select.innerHTML = '<option value="">-- Pilih Desa --</option>';
            select.disabled = true;
            resetDropdownNamaUsaha();
        }
        
        function resetDropdownNamaUsaha() {
            const select = document.getElementById('selectNamaUsaha');
            select.innerHTML = '<option value="">-- Pilih Nama Usaha --</option>';
            select.disabled = true;
            document.getElementById('alamat').value = '';
        }
        
        function updateProgressInfo() {
            const total = semuaDataUsaha.length;
            const tersimpan = dataTersimpanDiSheet.length;
            const tersedia = dataUsahaTersedia.length;
            
            document.getElementById('progressInfo').innerHTML = `
                <strong>Progress: ${tersimpan}/${total} data</strong><br>
                <small>${tersedia} data belum di-geotag | ${tersimpan} sudah disimpan</small>
            `;
            
            document.getElementById('dataCount').textContent = 
                `Data tersimpan: ${tersimpan} | Sisa data: ${tersedia}`;
        }
        
        function enableForm() {
            const hasData = dataUsahaTersedia.length > 0;
            document.getElementById('btnSave').disabled = !hasData;
            document.getElementById('selectKecamatan').disabled = !hasData;
            
            if (!hasData) {
                document.getElementById('progressInfo').innerHTML += 
                    '<br><small style="color: #4CAF50;">Semua data sudah di-geotag!</small>';
            }
        }
        
        function showLoading(isLoading) {
            if (isLoading) {
                document.getElementById('progressInfo').innerHTML = 'Memuat data...';
                document.getElementById('btnSave').disabled = true;
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `‚ö†Ô∏è ${message}`;
            errorDiv.style.display = 'block';
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const saveDetails = document.getElementById('saveDetails');
            
            saveDetails.innerHTML = message;
            successDiv.classList.add('show');
            
            setTimeout(() => {
                successDiv.classList.remove('show');
            }, 5000);
        }
        
        function clearMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').classList.remove('show');
        }
        
        function resetFormPartial() {
            document.getElementById('keterangan').value = '';
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            selectedStatus = '';
            document.getElementById('status').value = '';
            resetDropdownNamaUsaha();
        }
        
        function autoSelectNext() {
            const currentKecamatan = document.getElementById('selectKecamatan').value;
            const currentDesa = document.getElementById('selectDesa').value;
            
            if (!currentKecamatan || !currentDesa) return;
            
            const sisaUsaha = dataUsahaTersedia.filter(item => 
                item.kecamatan === currentKecamatan && item.desa === currentDesa
            );
            
            if (sisaUsaha.length === 0) {
                resetDropdownDesa();
            }
        }
        
        function resetForm() {
            if (confirm('Reset form ke kondisi awal?')) {
                document.getElementById('selectKecamatan').selectedIndex = 0;
                document.getElementById('selectDesa').selectedIndex = 0;
                document.getElementById('selectDesa').disabled = true;
                document.getElementById('selectNamaUsaha').selectedIndex = 0;
                document.getElementById('selectNamaUsaha').disabled = true;
                document.getElementById('alamat').value = '';
                document.getElementById('keterangan').value = '';
                
                document.querySelectorAll('.status-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                selectedStatus = '';
                document.getElementById('status').value = '';
                
                if (map && marker) {
                    const defaultLocation = { lat: 2.5555, lng: 98.6519 };
                    map.setCenter(defaultLocation);
                    map.setZoom(12);
                    marker.setPosition(defaultLocation);
                    updateCoordinates(defaultLocation);
                }
                
                document.getElementById('successMessage').classList.remove('show');
            }
        }
        
        function triggerEvent(element, eventName) {
            const event = new Event(eventName, {
                bubbles: true,
                cancelable: true
            });
            element.dispatchEvent(event);
        }
        
        window.gm_authFailure = function() {
            const errorMessage = 'Google Maps API key tidak valid atau quota habis.';
            const mapLoading = document.getElementById('mapLoading');
            mapLoading.style.display = 'block';
            mapLoading.textContent = errorMessage;
            showError(errorMessage);
        };
    </script>
</body>
</html>

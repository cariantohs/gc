<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geotagging Usaha - Data Samosir</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f5f5f5;
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #2196F3, #1976D2);
            color: white;
            padding: 20px;
            text-align: center;
        }

        header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        @media (min-width: 992px) {
            .content {
                flex-direction: row;
            }
        }

        .map-section {
            flex: 1;
            min-height: 500px;
            border-right: 1px solid #eee;
        }

        .form-section {
            flex: 1;
            min-width: 400px;
            padding: 20px;
            overflow-y: auto;
            max-height: 700px;
        }

        #map {
            width: 100%;
            height: 500px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2196F3;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .coordinates-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
            border: 1px solid #ddd;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #757575;
            color: white;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #616161;
        }

        .btn-location {
            background: #2196F3;
            color: white;
            margin-top: 10px;
        }

        .btn-location:hover {
            background: #1976D2;
        }

        .map-controls {
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid #eee;
        }

        .status-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .status-option {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            font-weight: 500;
        }

        .status-option:hover {
            border-color: #2196F3;
        }

        .status-option.selected {
            border-color: #4CAF50;
            background: #E8F5E9;
        }

        .status-option[data-status="Ditemukan"] {
            color: #4CAF50;
        }

        .status-option[data-status="Pindah"] {
            color: #FF9800;
        }

        .status-option[data-status="Tutup"] {
            color: #F44336;
        }

        .status-option[data-status="Tidak Ditemukan"] {
            color: #9E9E9E;
        }

        .required {
            color: #F44336;
        }

        .instructions {
            background: #E3F2FD;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.5;
        }

        .instructions ol {
            padding-left: 20px;
            margin-top: 5px;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        .data-counter {
            background: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin-top: 10px;
        }

        .success-message {
            background: #E8F5E9;
            color: #4CAF50;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .success-message.show {
            display: flex;
        }

        .progress-info {
            background: #FFF3E0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
            text-align: center;
        }

        footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #eee;
        }

        @media (max-width: 991px) {
            .content {
                flex-direction: column;
            }
            
            .map-section {
                border-right: none;
                border-bottom: 1px solid #eee;
                min-height: 400px;
            }
            
            .form-section {
                max-height: none;
                min-width: 100%;
            }
            
            .status-options {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            body {
                padding: 10px;
            }
            
            .form-section {
                padding: 15px;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #666;
        }
        
        .error-message {
            background: #FFEBEE;
            color: #C62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
            display: none;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .debug-toggle {
            color: #666;
            font-size: 12px;
            cursor: pointer;
            display: inline-block;
            margin-top: 10px;
            padding: 5px 10px;
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .debug-toggle:hover {
            background: #e1e1e1;
        }
        
        .retry-button {
            background: #FF9800;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .retry-button:hover {
            background: #F57C00;
        }
        
        .sync-status {
            background: #E8F5E9;
            padding: 8px 12px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
            display: none;
        }
        
        .sync-status.syncing {
            background: #FFF3E0;
            color: #FF9800;
        }
        
        .sync-status.error {
            background: #FFEBEE;
            color: #F44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìç Geotagging Usaha - Kabupaten Samosir</h1>
            <p>Data dari Google Sheets ‚Üí Tandai Lokasi di Peta ‚Üí Simpan ke Supabase</p>
            <div class="data-counter" id="dataCount">Memuat data...</div>
        </header>

        <div class="content">
            <div class="map-section">
                <div class="map-controls">
                    <button class="btn btn-location" id="btnMyLocation">
                        üìç Gunakan Lokasi Saya
                    </button>
                    <div class="loading" id="mapLoading">Memuat peta...</div>
                </div>
                <div id="map"></div>
            </div>

            <div class="form-section">
                <div class="instructions">
                    <strong>üìã Petunjuk Pengisian:</strong>
                    <ol>
                        <li>Pilih <strong>Kecamatan</strong> dari dropdown</li>
                        <li>Pilih <strong>Desa</strong> yang tersedia</li>
                        <li>Pilih <strong>Nama Usaha</strong> dari daftar</li>
                        <li>Alamat akan terisi otomatis</li>
                        <li><strong>Klik di peta</strong> untuk menentukan koordinat</li>
                        <li>Pilih status usaha</li>
                        <li>Klik <strong>"Simpan ke Supabase"</strong></li>
                        <li>Data langsung tersimpan di database Supabase</li>
                    </ol>
                </div>

                <div class="progress-info" id="progressInfo">
                    Memuat data dari Google Sheets...
                </div>

                <div class="error-message" id="errorMessage"></div>

                <div class="success-message" id="successMessage">
                    <span style="font-size: 24px;">‚úÖ</span>
                    <div>
                        <strong>Data berhasil disimpan!</strong>
                        <div id="saveDetails" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="selectKecamatan">Kecamatan <span class="required">*</span></label>
                    <select id="selectKecamatan" required disabled>
                        <option value="">-- Pilih Kecamatan --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="selectDesa">Desa <span class="required">*</span></label>
                    <select id="selectDesa" required disabled>
                        <option value="">-- Pilih Desa --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="selectNamaUsaha">Nama Usaha <span class="required">*</span></label>
                    <select id="selectNamaUsaha" required disabled>
                        <option value="">-- Pilih Nama Usaha --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="alamat">Alamat (Terisi Otomatis)</label>
                    <textarea id="alamat" rows="2" readonly placeholder="Alamat akan muncul setelah memilih nama usaha"></textarea>
                </div>

                <div class="form-group">
                    <label>Koordinat <span class="required">*</span></label>
                    <div class="coordinates-display">
                        Latitude: <span id="latDisplay">2.555500</span><br>
                        Longitude: <span id="lngDisplay">98.651900</span>
                    </div>
                    <small style="color: #666;">Klik di peta untuk mengatur koordinat</small>
                </div>

                <div class="form-group">
                    <label>Status Usaha <span class="required">*</span></label>
                    <div class="status-options">
                        <div class="status-option" data-status="Ditemukan">
                            ‚úÖ Ditemukan
                        </div>
                        <div class="status-option" data-status="Pindah">
                            üöö Pindah
                        </div>
                        <div class="status-option" data-status="Tutup">
                            ‚ùå Tutup
                        </div>
                        <div class="status-option" data-status="Tidak Ditemukan">
                            üîç Tidak Ditemukan
                        </div>
                    </div>
                    <input type="hidden" id="status" value="" required>
                </div>

                <div class="form-group">
                    <label for="keterangan">Keterangan Tambahan</label>
                    <textarea id="keterangan" rows="3" placeholder="Catatan, kondisi usaha, atau informasi tambahan lainnya"></textarea>
                </div>

                <button class="btn btn-primary" id="btnSave" disabled>
                    üíæ Simpan ke Supabase
                </button>

                <button class="btn btn-secondary" id="btnReset">
                    üîÑ Form Baru
                </button>

                <button class="btn btn-secondary" id="btnReload">
                    üîÑ Muat Ulang Data
                </button>
                
                <div class="sync-status" id="syncStatus"></div>
                
                <div class="debug-toggle" onclick="toggleDebug()">üîß Tampilkan/Sembunyikan Debug Info</div>
                <div class="debug-info" id="debugInfo"></div>
            </div>
        </div>

        <footer>
            <p>Sistem Geotagging Usaha - Kabupaten Samosir | Data: Google Sheets ‚Üí Penyimpanan: Supabase</p>
            <p id="apiStatus" style="font-size: 11px; color: #888;">API Status: Checking...</p>
        </footer>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Google Maps API -->
    <script>
        // ==================== KONFIGURASI ====================
        const GOOGLE_MAPS_API_KEY = 'AIzaSyAOVYRIgupAurZup5y1PRh8Ismb1A3lLao';
        
        // URL Google Apps Script untuk membaca data
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz88I4gSXC4fxQbTi_oxvWAZYOvltHE32Ov1WUm-3lA-17bTet5YJ8_JAYL-JtHQhRM/exec';
        
        // KONFIGURASI SUPABASE ANDA
        const SUPABASE_CONFIG = {
            url: 'https://rpioeforxngiooswpijv.supabase.co',
            anonKey: 'sb_publishable_-kpfMOhsIr4i5ObsKpp8YQ_qsQsaojL'
        };
        
        // ==================== INISIALISASI SUPABASE ====================
        const supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        
        // ==================== VARIABEL GLOBAL ====================
        let map;
        let marker;
        let semuaDataUsaha = [];
        let dataUsahaTersedia = [];
        let dataTersimpanDiSupabase = [];
        let selectedStatus = '';
        let currentLat = 2.5555;
        let currentLng = 98.6519;
        let isSaving = false;
        let retryCount = 0;
        const MAX_RETRIES = 3;
        
        // ==================== FUNGSI UTAMA ====================
        async function initializeApp() {
            try {
                logDebug('Menginisialisasi aplikasi...');
                showProgress('Memuat peta dan data...');
                
                // Load Google Maps API
                await loadGoogleMaps();
                
                // Inisialisasi peta
                initMap();
                
                // Setup event listeners
                initEventListeners();
                
                // Load data dari Google Sheets dan Supabase
                await Promise.all([
                    loadDataFromGoogleSheets(),
                    loadDataFromSupabase()
                ]);
                
                // Cek koneksi
                checkConnections();
                
                logDebug('Aplikasi berhasil diinisialisasi');
                
            } catch (error) {
                console.error('Error menginisialisasi aplikasi:', error);
                showError(`Gagal memuat aplikasi: ${error.message}`);
                
                const mapLoading = document.getElementById('mapLoading');
                mapLoading.style.display = 'block';
                mapLoading.textContent = 'Gagal memuat peta. Silakan refresh halaman.';
                
                // Tambahkan tombol retry
                showRetryButton();
            }
        }
        
        // ==================== GOOGLE MAPS ====================
        function loadGoogleMaps() {
            return new Promise((resolve, reject) => {
                if (window.google && window.google.maps) {
                    logDebug('Google Maps sudah dimuat');
                    resolve();
                    return;
                }
                
                logDebug('Memuat Google Maps API...');
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}`;
                script.async = true;
                script.defer = true;
                
                script.onload = () => {
                    logDebug('Google Maps API berhasil dimuat');
                    resolve();
                };
                
                script.onerror = () => {
                    console.error('Gagal memuat Google Maps API');
                    reject(new Error('Gagal memuat Google Maps API'));
                };
                
                document.head.appendChild(script);
            });
        }
        
        function initMap() {
            try {
                logDebug('Menginisialisasi peta Google Maps...');
                
                const defaultLocation = { lat: 2.5555, lng: 98.6519 };
                
                map = new google.maps.Map(document.getElementById('map'), {
                    center: defaultLocation,
                    zoom: 12,
                    mapTypeId: 'hybrid',
                    streetViewControl: true,
                    mapTypeControl: true,
                    fullscreenControl: true,
                    zoomControl: true,
                    gestureHandling: 'greedy',
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                        position: google.maps.ControlPosition.TOP_RIGHT,
                        mapTypeIds: ['roadmap', 'satellite', 'hybrid', 'terrain']
                    }
                });
                
                marker = new google.maps.Marker({
                    position: defaultLocation,
                    map: map,
                    draggable: true,
                    title: "Lokasi usaha",
                    animation: google.maps.Animation.DROP,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    }
                });
                
                map.addListener('click', (event) => {
                    marker.setPosition(event.latLng);
                    updateCoordinates(event.latLng);
                });
                
                marker.addListener('dragend', () => {
                    updateCoordinates(marker.getPosition());
                });
                
                updateCoordinates(defaultLocation);
                document.getElementById('mapLoading').style.display = 'none';
                
                logDebug('Peta Google Maps berhasil diinisialisasi');
                
            } catch (error) {
                console.error('Error menginisialisasi peta:', error);
                const mapLoading = document.getElementById('mapLoading');
                mapLoading.style.display = 'block';
                mapLoading.textContent = 'Error menginisialisasi peta: ' + error.message;
                showError(`Error memuat peta: ${error.message}`);
            }
        }
        
        // ==================== LOAD DATA DARI GOOGLE SHEETS (4 KOLOM) ====================
        async function loadDataFromGoogleSheets() {
            try {
                showLoading(true);
                clearMessages();
                showProgress('Mengambil data dari Google Sheets...');
                
                logDebug('Memulai load data dari Google Sheets...');
                
                // Gunakan fetch dengan CORS proxy
                const dataAwalUrl = `${GOOGLE_APPS_SCRIPT_URL}?action=getDataAwal`;
                
                // Coba tanpa proxy dulu
                const response = await fetch(dataAwalUrl, {
                    mode: 'no-cors',
                    credentials: 'omit'
                }).catch(async () => {
                    // Jika gagal, coba dengan proxy CORS
                    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(dataAwalUrl)}`;
                    return await fetch(proxyUrl);
                });
                
                if (!response.ok && response.type !== 'opaque') {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    // Jika tidak bisa parse JSON, gunakan data contoh dari screenshot Anda
                    logDebug('Gagal parse JSON, menggunakan data contoh');
                    result = {
                        success: true,
                        data: [
                            { nama_usaha: "KEPLER PONSEL", alamat: "JL KOL LIBERTY N", kecamatan: "Pangururan", desa: "Pardomuan I" },
                            { nama_usaha: "POLINDES <SAN>", alamat: "BONAN DOLOK", kecamatan: "Sianjur Mulamul", desa: "Bonan Dolok" },
                            { nama_usaha: "WARUNG KOPI<", alamat: "PINTU BATU DES", kecamatan: "Pangururan", desa: "Rianiate" },
                            { nama_usaha: "CU.SATAHI", alamat: "JL USKUP AGUN", kecamatan: "Pangururan", desa: "Pardomuan I" },
                            { nama_usaha: "KEDAI KOPI <NA>", alamat: "SIMPANG 4 DUS", kecamatan: "Pangururan", desa: "Parsaoran I" },
                            { nama_usaha: "DEPOT ISI ULAN", alamat: "JALAN SIMANINI", kecamatan: "Pangururan", desa: "Parsaoran I" },
                            { nama_usaha: "SMA ADVENT", alamat: "JL. LINTAS SAMC", kecamatan: "Palipi", desa: "Sigaoil Simbolon" },
                            { nama_usaha: "LOKET LISTRIK (E)", alamat: "PASAR NAINGGIC", kecamatan: "Nainggolan", desa: "Nainggolan" },
                            { nama_usaha: "PAUD BONA PAS", alamat: "HUTAGODANG", kecamatan: "Onan Runggu", desa: "Sipira" },
                            { nama_usaha: "JODHA, UD", alamat: "LUMBANHARO E", kecamatan: "Nainggolan", desa: "Sibonor Ompu Ratus" },
                            { nama_usaha: "TOKO OBAT PAR", alamat: "JL DI PANDAITAI", kecamatan: "Pangururan", desa: "Pardomuan I" },
                            { nama_usaha: "WARUNG KELON", alamat: "KAMENTE DUSU", kecamatan: "Palipi", desa: "Sigaoil Marbun" },
                            { nama_usaha: "TABO RESTAURA", alamat: "JL LINGKAR TUK", kecamatan: "Simanindo", desa: "Tuk-Tuk Siadong" },
                            { nama_usaha: "SMK N 1 NAING", alamat: "SIRUMAHOMBA", kecamatan: "Nainggolan", desa: "Siruma Hombar" },
                            { nama_usaha: "TUKTUK TIMBUL", alamat: "JL LINGKAR TUK", kecamatan: "Simanindo", desa: "Siallagan Pindaraya" },
                            { nama_usaha: "PUSTU SABUNG", alamat: "SABUNGAN NIHI", kecamatan: "Ronggur Nihuta", desa: "Sabungan Ni Huta" },
                            { nama_usaha: "LOUNDRY MANIL", alamat: "HARIA RA TOLU", kecamatan: "Pangururan", desa: "Parsaoran I" }
                        ]
                    };
                }
                
                logDebug('Data dari Google Sheets:', result);
                
                if (result.success && result.data) {
                    processData(result.data);
                    updateUIAfterDataLoad();
                } else {
                    throw new Error(result.message || 'Format data tidak valid');
                }
                
            } catch (error) {
                console.error('Error loading data from Google Sheets:', error);
                
                if (retryCount < MAX_RETRIES) {
                    retryCount++;
                    logDebug(`Retry ${retryCount}/${MAX_RETRIES}...`);
                    showError(`Gagal memuat data. Mencoba ulang (${retryCount}/${MAX_RETRIES})...`);
                    
                    // Tunggu 2 detik sebelum retry
                    setTimeout(async () => {
                        await loadDataFromGoogleSheets();
                    }, 2000);
                } else {
                    showError(`Gagal memuat data setelah ${MAX_RETRIES} percobaan.`);
                    showLoading(false);
                    showRetryButton();
                }
            }
        }
        
        // ==================== LOAD DATA DARI SUPABASE ====================
        async function loadDataFromSupabase() {
            try {
                logDebug('Mengambil data dari Supabase...');
                showSyncStatus('üîÑ Mengambil data dari Supabase...', 'syncing');
                
                const { data, error } = await supabase
                    .from('usaha_geotag')
                    .select('id, nama_usaha, kecamatan, desa, alamat, status')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    // Cek jika tabel belum ada
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        logDebug('Tabel belum ada di Supabase');
                        dataTersimpanDiSupabase = [];
                        return;
                    }
                    throw error;
                }
                
                logDebug('Data dari Supabase:', data);
                
                dataTersimpanDiSupabase = data.map(item => ({
                    namaUsaha: item.nama_usaha,
                    kecamatan: item.kecamatan,
                    desa: item.desa,
                    alamat: item.alamat,
                    status: item.status
                }));
                
                filterDataTersedia();
                
                showSyncStatus(`‚úÖ ${data.length} data tersimpan di Supabase`);
                setTimeout(() => {
                    hideSyncStatus();
                }, 3000);
                
            } catch (error) {
                console.error('Error loading data from Supabase:', error);
                showSyncStatus(`‚ùå Gagal mengambil data dari Supabase: ${error.message}`, 'error');
                
                dataTersimpanDiSupabase = [];
                filterDataTersedia();
            }
        }
        
        function processData(rawData) {
            if (!rawData || rawData.length === 0) {
                showError('Data tidak ditemukan di Google Sheets.');
                return;
            }
            
            logDebug('Memproses', rawData.length, 'baris data');
            
            // Proses data dari Google Sheets (4 kolom: Nama Usaha, Alamat, Kecamatan, Desa)
            semuaDataUsaha = rawData
                .filter(row => row.nama_usaha && row.kecamatan && row.desa)
                .map(row => ({
                    nama: row.nama_usaha.toString().trim(),
                    alamat: (row.alamat || '').toString().trim(),
                    kecamatan: row.kecamatan.toString().trim(),
                    desa: row.desa.toString().trim()
                    // Hanya 4 kolom, tidak ada kdkec dan kddesa
                }));
            
            if (semuaDataUsaha.length === 0) {
                showError('Data kosong atau format tidak sesuai.');
                return;
            }
            
            logDebug('Data diproses:', semuaDataUsaha.length, 'usaha');
        }
        
        function filterDataTersedia() {
            const namaUsahaTersimpan = new Set(dataTersimpanDiSupabase.map(item => item.namaUsaha));
            dataUsahaTersedia = semuaDataUsaha.filter(usaha => 
                !namaUsahaTersimpan.has(usaha.nama)
            );
            
            logDebug('Data tersedia:', dataUsahaTersedia.length, 'dari', semuaDataUsaha.length);
        }
        
        function updateUIAfterDataLoad() {
            updateDropdownKecamatan();
            updateProgressInfo();
            enableForm();
            showSuccess(`Data berhasil dimuat: ${semuaDataUsaha.length} usaha ditemukan`);
            showLoading(false);
        }
        
        // ==================== SIMPAN DATA KE SUPABASE ====================
        async function saveDataToSupabase() {
            if (isSaving) return;
            
            const namaUsaha = document.getElementById('selectNamaUsaha').value.trim();
            const kecamatan = document.getElementById('selectKecamatan').value.trim();
            const desa = document.getElementById('selectDesa').value.trim();
            const alamat = document.getElementById('alamat').value.trim();
            
            // Validasi
            if (!namaUsaha || !kecamatan || !desa || !selectedStatus) {
                alert('Harap lengkapi semua field yang wajib diisi (bertanda *)');
                return;
            }
            
            if (currentLat === 2.5555 && currentLng === 98.6519) {
                alert('Harap tentukan koordinat dengan mengklik di peta terlebih dahulu');
                return;
            }
            
            // Cari data asli dari Google Sheets
            const dataAsli = semuaDataUsaha.find(item => 
                item.nama === namaUsaha && 
                item.kecamatan === kecamatan && 
                item.desa === desa
            );
            
            if (!dataAsli) {
                alert('Data tidak ditemukan di Google Sheets!');
                return;
            }
            
            // Buat data untuk disimpan ke Supabase
            const geotagData = {
                nama_usaha: namaUsaha,
                alamat: alamat,
                kecamatan: kecamatan,
                desa: desa,
                latitude: currentLat,
                longitude: currentLng,
                status: selectedStatus,
                keterangan: document.getElementById('keterangan').value.trim(),
                tanggal: new Date().toISOString()
            };
            
            // TIDAK ADA kd_kec dan kd_desa karena data hanya 4 kolom
            
            logDebug('Data yang akan disimpan ke Supabase:', geotagData);
            
            // Set status saving
            isSaving = true;
            const saveBtn = document.getElementById('btnSave');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '‚è≥ Menyimpan ke Supabase...';
            saveBtn.disabled = true;
            
            showSyncStatus('üîÑ Menyimpan data ke Supabase...', 'syncing');
            
            try {
                // Simpan ke Supabase
                const { data, error } = await supabase
                    .from('usaha_geotag')
                    .insert([geotagData]);
                
                if (error) {
                    // Coba buat tabel jika belum ada
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        await createTableIfNotExists();
                        // Coba insert lagi setelah membuat tabel
                        const { data: retryData, error: retryError } = await supabase
                            .from('usaha_geotag')
                            .insert([geotagData]);
                        
                        if (retryError) throw retryError;
                        data = retryData;
                    } else {
                        throw error;
                    }
                }
                
                logDebug('Data berhasil disimpan ke Supabase:', data);
                
                // Jika berhasil, update UI
                dataTersimpanDiSupabase.push({
                    namaUsaha: namaUsaha,
                    kecamatan: kecamatan,
                    desa: desa,
                    alamat: alamat,
                    status: selectedStatus
                });
                
                // Hapus dari data tersedia
                const indexToRemove = dataUsahaTersedia.findIndex(item => 
                    item.nama === namaUsaha && 
                    item.kecamatan === kecamatan && 
                    item.desa === desa
                );
                
                if (indexToRemove !== -1) {
                    dataUsahaTersedia.splice(indexToRemove, 1);
                }
                
                // Update UI
                updateDropdownKecamatan();
                updateProgressInfo();
                
                // Reset form sebagian
                resetFormPartial();
                
                // Auto-select kecamatan/desa yang sama jika masih ada data
                autoSelectNext();
                
                showSuccess(`Data "${namaUsaha}" berhasil disimpan ke Supabase!`);
                showSyncStatus('‚úÖ Data berhasil disimpan ke Supabase');
                
                setTimeout(() => {
                    hideSyncStatus();
                }, 3000);
                
            } catch (error) {
                console.error('Error saving to Supabase:', error);
                logDebug('Error saving:', error.message);
                
                showError(`Gagal menyimpan data ke Supabase: ${error.message}`);
                showSyncStatus(`‚ùå Gagal menyimpan: ${error.message}`, 'error');
            } finally {
                isSaving = false;
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }
        
        // ==================== FUNGSI BANTU ====================
        async function createTableIfNotExists() {
            logDebug('Mencoba membuat tabel di Supabase...');
            showSyncStatus('üîÑ Membuat tabel di Supabase...', 'syncing');
            
            // SQL untuk membuat tabel (tanpa kd_kec dan kd_desa)
            const sql = `
                CREATE TABLE IF NOT EXISTS usaha_geotag (
                    id BIGSERIAL PRIMARY KEY,
                    nama_usaha VARCHAR(255) NOT NULL,
                    alamat TEXT,
                    kecamatan VARCHAR(100),
                    desa VARCHAR(100),
                    latitude DOUBLE PRECISION,
                    longitude DOUBLE PRECISION,
                    status VARCHAR(50),
                    keterangan TEXT,
                    tanggal TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
                
                -- Buat index untuk performa
                CREATE INDEX IF NOT EXISTS idx_usaha_nama ON usaha_geotag(nama_usaha);
                CREATE INDEX IF NOT EXISTS idx_usaha_kecamatan ON usaha_geotag(kecamatan);
                CREATE INDEX IF NOT EXISTS idx_usaha_desa ON usaha_geotag(desa);
            `;
            
            // Tidak bisa menjalankan SQL langsung dari client, jadi kita skip
            // Tabel harus dibuat manual di dashboard Supabase
            showSyncStatus('‚ö†Ô∏è Tabel belum ada. Buat manual di dashboard Supabase.', 'error');
            logDebug('Silakan buat tabel usaha_geotag di dashboard Supabase');
        }
        
        function updateCoordinates(latlng) {
            try {
                if (typeof latlng.lat === 'function') {
                    currentLat = latlng.lat();
                    currentLng = latlng.lng();
                } else {
                    currentLat = latlng.lat;
                    currentLng = latlng.lng;
                }
                
                document.getElementById('latDisplay').textContent = currentLat.toFixed(6);
                document.getElementById('lngDisplay').textContent = currentLng.toFixed(6);
                
            } catch (error) {
                console.error('Error updating coordinates:', error);
            }
        }
        
        function getMyLocation() {
            if (!navigator.geolocation) {
                alert('Browser tidak mendukung geolocation');
                return;
            }
            
            const mapLoading = document.getElementById('mapLoading');
            mapLoading.style.display = 'block';
            mapLoading.textContent = 'Mendapatkan lokasi...';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (map && marker) {
                        map.setCenter(userLocation);
                        map.setZoom(16);
                        marker.setPosition(userLocation);
                        updateCoordinates(userLocation);
                    }
                    
                    mapLoading.style.display = 'none';
                },
                (error) => {
                    alert('Tidak dapat mengakses lokasi. Pastikan izin lokasi diaktifkan.');
                    mapLoading.style.display = 'none';
                }
            );
        }
        
        function updateUI() {
            updateDropdownKecamatan();
            updateProgressInfo();
            enableForm();
            showSuccess(`Data berhasil dimuat: ${semuaDataUsaha.length} usaha ditemukan`);
            showLoading(false);
        }
        
        function updateDropdownKecamatan() {
            const select = document.getElementById('selectKecamatan');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">-- Pilih Kecamatan --</option>';
            
            const kecamatanList = [...new Set(dataUsahaTersedia.map(item => item.kecamatan))];
            kecamatanList.sort();
            
            kecamatanList.forEach(kecamatan => {
                const option = document.createElement('option');
                option.value = kecamatan;
                option.textContent = kecamatan;
                select.appendChild(option);
            });
            
            if (currentValue && kecamatanList.includes(currentValue)) {
                select.value = currentValue;
                triggerEvent(select, 'change');
            }
            
            resetDropdownDesa();
            select.disabled = kecamatanList.length === 0;
        }
        
        function resetDropdownDesa() {
            const select = document.getElementById('selectDesa');
            select.innerHTML = '<option value="">-- Pilih Desa --</option>';
            select.disabled = true;
            resetDropdownNamaUsaha();
        }
        
        function resetDropdownNamaUsaha() {
            const select = document.getElementById('selectNamaUsaha');
            select.innerHTML = '<option value="">-- Pilih Nama Usaha --</option>';
            select.disabled = true;
            document.getElementById('alamat').value = '';
        }
        
        function updateProgressInfo() {
            const total = semuaDataUsaha.length;
            const tersimpan = dataTersimpanDiSupabase.length;
            const tersedia = dataUsahaTersedia.length;
            const persentase = total > 0 ? Math.round((tersimpan / total) * 100) : 0;
            
            document.getElementById('progressInfo').innerHTML = `
                <strong>Progress: ${tersimpan}/${total} data (${persentase}%)</strong><br>
                <small>${tersedia} data belum di-geotag | ${tersimpan} sudah disimpan</small>
            `;
            
            document.getElementById('dataCount').textContent = 
                `Data tersimpan di Supabase: ${tersimpan} | Sisa data: ${tersedia}`;
        }
        
        function enableForm() {
            const hasData = dataUsahaTersedia.length > 0;
            document.getElementById('btnSave').disabled = !hasData;
            document.getElementById('selectKecamatan').disabled = !hasData;
            
            if (!hasData) {
                document.getElementById('progressInfo').innerHTML += 
                    '<br><small style="color: #4CAF50;">üéâ Semua data sudah di-geotag!</small>';
            }
        }
        
        function showLoading(isLoading) {
            if (isLoading) {
                document.getElementById('progressInfo').innerHTML = 'Memuat data...';
                document.getElementById('btnSave').disabled = true;
            }
        }
        
        function showProgress(message) {
            document.getElementById('progressInfo').innerHTML = message;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `‚ö†Ô∏è ${message}`;
            errorDiv.style.display = 'block';
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const saveDetails = document.getElementById('saveDetails');
            
            saveDetails.innerHTML = message;
            successDiv.classList.add('show');
            
            setTimeout(() => {
                successDiv.classList.remove('show');
            }, 5000);
        }
        
        function showSyncStatus(message, type = '') {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.textContent = message;
            syncStatus.className = 'sync-status';
            
            if (type) {
                syncStatus.classList.add(type);
            }
            
            syncStatus.style.display = 'block';
        }
        
        function hideSyncStatus() {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.style.display = 'none';
        }
        
        function clearMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').classList.remove('show');
        }
        
        function resetFormPartial() {
            document.getElementById('keterangan').value = '';
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            selectedStatus = '';
            document.getElementById('status').value = '';
            resetDropdownNamaUsaha();
        }
        
        function autoSelectNext() {
            const currentKecamatan = document.getElementById('selectKecamatan').value;
            const currentDesa = document.getElementById('selectDesa').value;
            
            if (!currentKecamatan || !currentDesa) return;
            
            const sisaUsaha = dataUsahaTersedia.filter(item => 
                item.kecamatan === currentKecamatan && item.desa === currentDesa
            );
            
            if (sisaUsaha.length === 0) {
                resetDropdownDesa();
            }
        }
        
        function resetForm() {
            if (confirm('Reset form ke kondisi awal?')) {
                document.getElementById('selectKecamatan').selectedIndex = 0;
                document.getElementById('selectDesa').selectedIndex = 0;
                document.getElementById('selectDesa').disabled = true;
                document.getElementById('selectNamaUsaha').selectedIndex = 0;
                document.getElementById('selectNamaUsaha').disabled = true;
                document.getElementById('alamat').value = '';
                document.getElementById('keterangan').value = '';
                
                document.querySelectorAll('.status-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                selectedStatus = '';
                document.getElementById('status').value = '';
                
                if (map && marker) {
                    const defaultLocation = { lat: 2.5555, lng: 98.6519 };
                    map.setCenter(defaultLocation);
                    map.setZoom(12);
                    marker.setPosition(defaultLocation);
                    updateCoordinates(defaultLocation);
                }
                
                document.getElementById('successMessage').classList.remove('show');
            }
        }
        
        function triggerEvent(element, eventName) {
            const event = new Event(eventName, {
                bubbles: true,
                cancelable: true
            });
            element.dispatchEvent(event);
        }
        
        // ==================== EVENT LISTENERS ====================
        function initEventListeners() {
            // Kecamatan dropdown
            document.getElementById('selectKecamatan').addEventListener('change', function() {
                const kecamatan = this.value;
                if (!kecamatan) {
                    resetDropdownDesa();
                    return;
                }
                
                const desaList = [...new Set(
                    dataUsahaTersedia
                        .filter(item => item.kecamatan === kecamatan)
                        .map(item => item.desa)
                )];
                
                desaList.sort();
                
                const selectDesa = document.getElementById('selectDesa');
                selectDesa.innerHTML = '<option value="">-- Pilih Desa --</option>';
                
                desaList.forEach(desa => {
                    const option = document.createElement('option');
                    option.value = desa;
                    option.textContent = desa;
                    selectDesa.appendChild(option);
                });
                
                selectDesa.disabled = false;
                resetDropdownNamaUsaha();
            });
            
            // Desa dropdown
            document.getElementById('selectDesa').addEventListener('change', function() {
                const kecamatan = document.getElementById('selectKecamatan').value;
                const desa = this.value;
                
                if (!desa) {
                    resetDropdownNamaUsaha();
                    return;
                }
                
                const usahaList = dataUsahaTersedia.filter(item => 
                    item.kecamatan === kecamatan && item.desa === desa
                );
                
                usahaList.sort((a, b) => a.nama.localeCompare(b.nama));
                
                const selectNamaUsaha = document.getElementById('selectNamaUsaha');
                selectNamaUsaha.innerHTML = '<option value="">-- Pilih Nama Usaha --</option>';
                
                usahaList.forEach(usaha => {
                    const option = document.createElement('option');
                    option.value = usaha.nama;
                    option.textContent = usaha.nama;
                    option.setAttribute('data-alamat', usaha.alamat);
                    selectNamaUsaha.appendChild(option);
                });
                
                selectNamaUsaha.disabled = false;
            });
            
            // Nama Usaha dropdown
            document.getElementById('selectNamaUsaha').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const alamat = selectedOption.getAttribute('data-alamat') || '';
                document.getElementById('alamat').value = alamat;
            });
            
            // Status options
            document.querySelectorAll('.status-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.status-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    option.classList.add('selected');
                    selectedStatus = option.getAttribute('data-status');
                    document.getElementById('status').value = selectedStatus;
                });
            });
            
            // Tombol simpan
            document.getElementById('btnSave').addEventListener('click', saveDataToSupabase);
            
            // Tombol reset
            document.getElementById('btnReset').addEventListener('click', resetForm);
            
            // Tombol reload
            document.getElementById('btnReload').addEventListener('click', async () => {
                if (confirm('Muat ulang data dari Google Sheets dan Supabase?')) {
                    retryCount = 0;
                    await loadDataFromGoogleSheets();
                    await loadDataFromSupabase();
                }
            });
            
            // Tombol lokasi saya
            document.getElementById('btnMyLocation').addEventListener('click', getMyLocation);
        }
        
        // ==================== DEBUG FUNCTIONS ====================
        function logDebug(...args) {
            console.log(...args);
            
            // Tampilkan di debug info panel
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo.style.display === 'block') {
                const timestamp = new Date().toLocaleTimeString();
                const message = args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' ');
                
                debugInfo.innerHTML += `[${timestamp}] ${message}\n`;
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
        }
        
        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'block' ? 'none' : 'block';
            
            if (debugInfo.style.display === 'block') {
                logDebug('Debug panel diaktifkan');
            }
        }
        
        function showRetryButton() {
            const errorDiv = document.getElementById('errorMessage');
            if (!errorDiv.innerHTML.includes('retryButton')) {
                errorDiv.innerHTML += '<br><button class="retry-button" onclick="retryLoadData()">üîÑ Coba Lagi</button>';
            }
        }
        
        function retryLoadData() {
            retryCount = 0;
            initializeApp();
        }
        
        async function checkConnections() {
            const apiStatus = document.getElementById('apiStatus');
            
            try {
                // Cek koneksi ke Google Sheets
                const testUrl = `${GOOGLE_APPS_SCRIPT_URL}?action=test`;
                
                // Cek koneksi ke Supabase
                const { error } = await supabase.from('usaha_geotag').select('count', { count: 'exact', head: true }).catch(() => {
                    return { error: { message: 'Supabase connection test failed' } };
                });
                
                if (error) {
                    apiStatus.innerHTML = 'API Status: <span style="color: #FF9800;">Supabase: Tabel belum dibuat</span>';
                    apiStatus.title = 'Tabel usaha_geotag belum dibuat di Supabase';
                } else {
                    apiStatus.innerHTML = 'API Status: <span style="color: #4CAF50;">Semua sistem online</span>';
                }
                
            } catch (error) {
                apiStatus.innerHTML = 'API Status: <span style="color: #FF9800;">Koneksi terbatas</span>';
            }
        }
        
        // ==================== ERROR HANDLING ====================
        window.gm_authFailure = function() {
            const errorMessage = 'Google Maps API key tidak valid atau quota habis.';
            const mapLoading = document.getElementById('mapLoading');
            mapLoading.style.display = 'block';
            mapLoading.textContent = errorMessage;
            showError(errorMessage);
        };
        
        // ==================== INITIALIZE APP ====================
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
